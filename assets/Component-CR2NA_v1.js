import{s as b,j as a,B as T,b as N}from"./components-P3HMgWxx.js";import{u as B,L as X,$,a as K,b as F,c as U,d as G,P as V,e as q}from"./index-D7-8M7Y0.js";import{L as J}from"./LexicalNestedComposer-B6ItfjO0.js";import{L as s,b as Q}from"./lexical-jWKiw7TX.js";import{r as f}from"./react-mhcLWgJf.js";import{ap as H}from"./fluentui-D10euT8-.js";import"./index-DQ4A6yrT.js";import"./vendor-Cg4l60Qw.js";import"./tools-BeP_WXzy.js";import"./rx-BIoNU6Ta.js";import"./signalr-wWpYR44r.js";function k(g,C,p){return Math.min(Math.max(g,C),p)}const o={east:1,north:8,south:2,west:4};function Z({onResizeStart:g,onResizeEnd:C,buttonRef:p,imageRef:E,maxWidth:v,editor:S,showCaption:_,setShowCaption:M,captionsEnabled:z}){const O=f.useRef(null),y=f.useRef({priority:"",value:"default"}),L=f.useRef({currentHeight:0,currentWidth:0,direction:0,isResizing:!1,ratio:0,startHeight:0,startWidth:0,startX:0,startY:0}),l=S.getRootElement(),h=v||(l?l.getBoundingClientRect().width-20:100),j=l?l.getBoundingClientRect().height-20:100,P=100,A=100;function u(t){const n=t===o.east||t===o.west,r=t===o.north||t===o.south,w=t&o.north&&t&o.west||t&o.south&&t&o.east,m=n?"ew":r?"ns":w?"nwse":"nesw";l&&l.style.setProperty("cursor",`${m}-resize`,"important"),document.body&&(document.body.style.setProperty("cursor",`${m}-resize`,"important"),y.current.value=document.body.style.getPropertyValue("-webkit-user-select"),y.current.priority=document.body.style.getPropertyPriority("-webkit-user-select"),document.body.style.setProperty("-webkit-user-select","none","important"))}function I(){l&&l.style.setProperty("cursor","default"),document.body&&(document.body.style.setProperty("cursor","default"),document.body.style.setProperty("-webkit-user-select",y.current.value,y.current.priority))}function x(t,n){if(!S.isEditable())return;const r=E.current,w=O.current;if(r&&w){const{width:m,height:i}=r.getBoundingClientRect(),e=L.current;e.startWidth=m,e.startHeight=i,e.ratio=m/i,e.currentWidth=m,e.currentHeight=i,e.startX=t.clientX,e.startY=t.clientY,e.isResizing=!0,e.direction=n,u(n),g(),w.classList.add("image-control-wrapper--resizing"),r.style.height=`${i}px`,r.style.width=`${m}px`,document.addEventListener("pointermove",W),document.addEventListener("pointerup",D)}}function W(t){const n=E.current,r=L.current,w=r.direction&(o.east|o.west),m=r.direction&(o.south|o.north);if(n&&r.isResizing)if(w&&m){let i=Math.floor(r.startX-t.clientX);i=r.direction&o.east?-i:i;const e=k(r.startWidth+i,P,h),d=e/r.ratio;n.style.width=`${e}px`,n.style.height=`${d}px`,r.currentHeight=d,r.currentWidth=e}else if(m){let i=Math.floor(r.startY-t.clientY);i=r.direction&o.south?-i:i;const e=k(r.startHeight+i,A,j);n.style.height=`${e}px`,r.currentHeight=e}else{let i=Math.floor(r.startX-t.clientX);i=r.direction&o.east?-i:i;const e=k(r.startWidth+i,P,h);n.style.width=`${e}px`,r.currentWidth=e}}function D(){const t=E.current,n=L.current,r=O.current;if(t&&r&&n.isResizing){const w=n.currentWidth,m=n.currentHeight;n.startWidth=0,n.startHeight=0,n.ratio=0,n.startX=0,n.startY=0,n.currentWidth=0,n.currentHeight=0,n.isResizing=!1,r.classList.remove("image-control-wrapper--resizing"),I(),C(w,m),document.removeEventListener("pointermove",W),document.removeEventListener("pointerup",D)}}const c=ee();return a.jsxs("div",{ref:O,children:[!_&&z&&a.jsx(T,{className:c.button,ref:p,onClick:()=>M(!_),children:"Add Caption"}),a.jsx("div",{className:N(c.resizer,c.n),onPointerDown:t=>x(t,o.north)}),a.jsx("div",{className:N(c.resizer,c.ne),onPointerDown:t=>x(t,o.north|o.east)}),a.jsx("div",{className:N(c.resizer,c.e),onPointerDown:t=>x(t,o.east)}),a.jsx("div",{className:N(c.resizer,c.se),onPointerDown:t=>x(t,o.south|o.east)}),a.jsx("div",{className:N(c.resizer,c.s),onPointerDown:t=>x(t,o.south)}),a.jsx("div",{className:N(c.resizer,c.sw),onPointerDown:t=>x(t,o.south|o.west)}),a.jsx("div",{className:N(c.resizer,c.w),onPointerDown:t=>x(t,o.west)}),a.jsx("div",{className:N(c.resizer,c.nw),onPointerDown:t=>x(t,o.north|o.west)})]})}const ee=H({button:{minWidth:"unset",fontWeight:"unset",width:"fit-content",position:"absolute",bottom:"20px",marginLeft:"auto",left:0,right:0,...b.margin(0,"auto")},resizer:{display:"block",width:"7px",height:"7px",position:"absolute",backgroundColor:"rgb(60, 132, 244)",...b.border("1px","solid","#fff")},n:{top:"-6px",left:"48%",cursor:"n-resize"},ne:{top:"-6px",right:"-6px",cursor:"ne-resize"},e:{bottom:"48%",right:"-6px",cursor:"e-resize"},se:{bottom:"-2px",right:"-6px",cursor:"nwse-resize"},s:{bottom:"-2px",left:"48%",cursor:"s-resize"},sw:{bottom:"-2px",left:"-6px",cursor:"sw-resize"},w:{bottom:"48%",left:"-6px",cursor:"w-resize"},nw:{top:"-6px",left:"-6px",cursor:"nw-resize"}}),te=H({caption:{display:"block",position:"absolute",bottom:"4px",left:0,right:0,...b.padding(0),...b.margin(0),...b.borderTop("1px","solid","#fff"),backgroundColor:"rgba(255, 255, 255, 0.9)",minWidth:"100px",color:"#000",...b.overflow("hidden")},content:{minHeight:"20px",...b.border(0),resize:"none",cursor:"text",caretColor:"rgb(5, 5, 5)",display:"block",position:"relative",tabSize:1,...b.outline(0),...b.padding("10px"),userSelect:"text",fontSize:"12px",width:"calc(100% - 20px)",whiteSpace:"pre-wrap",wordBreak:"break-word"},placeholder:{fontSize:"12px",color:"#888",...b.overflow("hidden"),position:"absolute",textOverflow:"ellipsis",top:"10px",left:"10px",userSelect:"none",whiteSpace:"nowrap",display:"inline-block",pointerEvents:"none"}}),Y=new Set;function re(g){if(!Y.has(g))throw new Promise(C=>{const p=new Image;p.src=g,p.onload=()=>{Y.add(g),C(null)}})}function se({altText:g,className:C,imageRef:p,src:E,width:v,height:S,maxWidth:_}){return re(E),a.jsx("img",{className:C||void 0,src:E,alt:g,ref:p,style:{height:S,maxWidth:_,width:v},draggable:"false"})}function ge({src:g,altText:C,nodeKey:p,width:E,height:v,maxWidth:S,resizable:_,showCaption:M,caption:z,captionsEnabled:O}){const y=f.useRef(null),L=f.useRef(null),[l,h,j]=B.useLexicalNodeSelection(p),[P,A]=f.useState(!1),[u]=X.useLexicalComposerContext(),[I,x]=f.useState(null),W=f.useRef(null),D=f.useCallback(e=>{if(l&&s.$isNodeSelection(s.$getSelection())){e.preventDefault();const R=s.$getNodeByKey(p);$(R)&&R.remove(),h(!1)}return!1},[l,p,h]),c=f.useCallback(e=>{const d=s.$getSelection(),R=L.current;if(l&&s.$isNodeSelection(d)&&d.getNodes().length===1){if(M)return s.$setSelection(null),e.preventDefault(),z.focus(),!0;if(R!==null&&R!==document.activeElement)return e.preventDefault(),R.focus(),!0}return!1},[z,l,M]),t=f.useCallback(e=>W.current===z||L.current===e.target?(s.$setSelection(null),u.update(()=>{h(!0);const d=u.getRootElement();d!==null&&d.focus()}),!0):!1,[z,u,h]);f.useEffect(()=>Q.mergeRegister(u.registerUpdateListener(({editorState:e})=>{x(e.read(()=>s.$getSelection()))}),u.registerCommand(s.SELECTION_CHANGE_COMMAND,(e,d)=>(W.current=d,!1),s.COMMAND_PRIORITY_LOW),u.registerCommand(s.CLICK_COMMAND,e=>{const d=e;return P?!0:d.target===y.current?(d.shiftKey?h(!l):(j(),h(!0)),!0):!1},s.COMMAND_PRIORITY_LOW),u.registerCommand(s.DRAGSTART_COMMAND,e=>e.target===y.current?(e.preventDefault(),!0):!1,s.COMMAND_PRIORITY_LOW),u.registerCommand(s.KEY_DELETE_COMMAND,D,s.COMMAND_PRIORITY_LOW),u.registerCommand(s.KEY_BACKSPACE_COMMAND,D,s.COMMAND_PRIORITY_LOW),u.registerCommand(s.KEY_ENTER_COMMAND,c,s.COMMAND_PRIORITY_LOW),u.registerCommand(s.KEY_ESCAPE_COMMAND,t,s.COMMAND_PRIORITY_LOW)),[j,u,P,l,p,D,c,t,h]);function n(){u.update(()=>{const e=s.$getNodeByKey(p);$(e)&&e.setShowCaption(!0)})}function r(e,d){setTimeout(()=>{A(!1)},200),u.update(()=>{const R=s.$getNodeByKey(p);$(R)&&R.setWidthAndHeight(e,d)})}const w=l&&s.$isNodeSelection(I)&&!P,m=l||P,i=te();return a.jsxs(f.Suspense,{children:[a.jsx("div",{draggable:w,children:a.jsx(se,{className:m?`focused ${s.$isNodeSelection(I)?"draggable":""}`:null,src:g,altText:C,imageRef:y,width:E,height:v,maxWidth:S})}),M&&a.jsx("div",{className:N("LexEditor_ImageCaption",i.caption),children:a.jsxs(J.LexicalNestedComposer,{initialEditor:z,children:[a.jsx(K.AutoFocusPlugin,{}),a.jsx(F,{}),a.jsx(U.RichTextPlugin,{contentEditable:a.jsx(G,{className:i.content}),placeholder:a.jsx(V,{className:i.placeholder,children:"Enter a caption..."}),ErrorBoundary:q})]})}),_&&s.$isNodeSelection(I)&&m&&a.jsx(Z,{showCaption:M,setShowCaption:n,editor:u,buttonRef:L,imageRef:y,maxWidth:S,onResizeStart:()=>A(!0),onResizeEnd:r,captionsEnabled:O})]})}export{ge as default};
