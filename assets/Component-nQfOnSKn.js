import{e as H,s as C,r as m,h as a,o as T,m as N}from"./index-pj1Qlxy7.js";import{u as B,L as X,a as r,$ as j,b as K,c as F,d as U,e as G,f as V,P as q,g as J}from"./index-T6XNbdIF.js";import{L as Q}from"./LexicalNestedComposer-bh4TrZVS.js";import"./index-oKmIU-zE.js";import"./random-r6yWGi8K.js";import"./toFinite-9qhUaaeg.js";import"./Subtitle1-eBiNuWS_.js";function k(f,b,p){return Math.min(Math.max(f,b),p)}const o={east:1,north:8,south:2,west:4};function Z({onResizeStart:f,onResizeEnd:b,buttonRef:p,imageRef:E,maxWidth:v,editor:S,showCaption:_,setShowCaption:M,captionsEnabled:z}){const O=m.useRef(null),y=m.useRef({priority:"",value:"default"}),P=m.useRef({currentHeight:0,currentWidth:0,direction:0,isResizing:!1,ratio:0,startHeight:0,startWidth:0,startX:0,startY:0}),l=S.getRootElement(),h=v||(l?l.getBoundingClientRect().width-20:100),A=l?l.getBoundingClientRect().height-20:100,L=100,$=100;function u(t){const n=t===o.east||t===o.west,s=t===o.north||t===o.south,w=t&o.north&&t&o.west||t&o.south&&t&o.east,g=n?"ew":s?"ns":w?"nwse":"nesw";l&&l.style.setProperty("cursor",`${g}-resize`,"important"),document.body&&(document.body.style.setProperty("cursor",`${g}-resize`,"important"),y.current.value=document.body.style.getPropertyValue("-webkit-user-select"),y.current.priority=document.body.style.getPropertyPriority("-webkit-user-select"),document.body.style.setProperty("-webkit-user-select","none","important"))}function I(){l&&l.style.setProperty("cursor","default"),document.body&&(document.body.style.setProperty("cursor","default"),document.body.style.setProperty("-webkit-user-select",y.current.value,y.current.priority))}function x(t,n){if(!S.isEditable())return;const s=E.current,w=O.current;if(s&&w){const{width:g,height:i}=s.getBoundingClientRect(),e=P.current;e.startWidth=g,e.startHeight=i,e.ratio=g/i,e.currentWidth=g,e.currentHeight=i,e.startX=t.clientX,e.startY=t.clientY,e.isResizing=!0,e.direction=n,u(n),f(),w.classList.add("image-control-wrapper--resizing"),s.style.height=`${i}px`,s.style.width=`${g}px`,document.addEventListener("pointermove",W),document.addEventListener("pointerup",D)}}function W(t){const n=E.current,s=P.current,w=s.direction&(o.east|o.west),g=s.direction&(o.south|o.north);if(n&&s.isResizing)if(w&&g){let i=Math.floor(s.startX-t.clientX);i=s.direction&o.east?-i:i;const e=k(s.startWidth+i,L,h),d=e/s.ratio;n.style.width=`${e}px`,n.style.height=`${d}px`,s.currentHeight=d,s.currentWidth=e}else if(g){let i=Math.floor(s.startY-t.clientY);i=s.direction&o.south?-i:i;const e=k(s.startHeight+i,$,A);n.style.height=`${e}px`,s.currentHeight=e}else{let i=Math.floor(s.startX-t.clientX);i=s.direction&o.east?-i:i;const e=k(s.startWidth+i,L,h);n.style.width=`${e}px`,s.currentWidth=e}}function D(){const t=E.current,n=P.current,s=O.current;if(t&&s&&n.isResizing){const w=n.currentWidth,g=n.currentHeight;n.startWidth=0,n.startHeight=0,n.ratio=0,n.startX=0,n.startY=0,n.currentWidth=0,n.currentHeight=0,n.isResizing=!1,s.classList.remove("image-control-wrapper--resizing"),I(),b(w,g),document.removeEventListener("pointermove",W),document.removeEventListener("pointerup",D)}}const c=ee();return a.jsxs("div",{ref:O,children:[!_&&z&&a.jsx(T,{className:c.button,ref:p,onClick:()=>M(!_),children:"Add Caption"}),a.jsx("div",{className:N(c.resizer,c.n),onPointerDown:t=>x(t,o.north)}),a.jsx("div",{className:N(c.resizer,c.ne),onPointerDown:t=>x(t,o.north|o.east)}),a.jsx("div",{className:N(c.resizer,c.e),onPointerDown:t=>x(t,o.east)}),a.jsx("div",{className:N(c.resizer,c.se),onPointerDown:t=>x(t,o.south|o.east)}),a.jsx("div",{className:N(c.resizer,c.s),onPointerDown:t=>x(t,o.south)}),a.jsx("div",{className:N(c.resizer,c.sw),onPointerDown:t=>x(t,o.south|o.west)}),a.jsx("div",{className:N(c.resizer,c.w),onPointerDown:t=>x(t,o.west)}),a.jsx("div",{className:N(c.resizer,c.nw),onPointerDown:t=>x(t,o.north|o.west)})]})}const ee=H({button:{minWidth:"unset",fontWeight:"unset",width:"fit-content",position:"absolute",bottom:"20px",marginLeft:"auto",left:0,right:0,...C.margin(0,"auto")},resizer:{display:"block",width:"7px",height:"7px",position:"absolute",backgroundColor:"rgb(60, 132, 244)",...C.border("1px","solid","#fff")},n:{top:"-6px",left:"48%",cursor:"n-resize"},ne:{top:"-6px",right:"-6px",cursor:"ne-resize"},e:{bottom:"48%",right:"-6px",cursor:"e-resize"},se:{bottom:"-2px",right:"-6px",cursor:"nwse-resize"},s:{bottom:"-2px",left:"48%",cursor:"s-resize"},sw:{bottom:"-2px",left:"-6px",cursor:"sw-resize"},w:{bottom:"48%",left:"-6px",cursor:"w-resize"},nw:{top:"-6px",left:"-6px",cursor:"nw-resize"}}),te=H({caption:{display:"block",position:"absolute",bottom:"4px",left:0,right:0,...C.padding(0),...C.margin(0),...C.borderTop("1px","solid","#fff"),backgroundColor:"rgba(255, 255, 255, 0.9)",minWidth:"100px",color:"#000",...C.overflow("hidden")},content:{minHeight:"20px",...C.border(0),resize:"none",cursor:"text",caretColor:"rgb(5, 5, 5)",display:"block",position:"relative",tabSize:1,...C.outline(0),...C.padding("10px"),userSelect:"text",fontSize:"12px",width:"calc(100% - 20px)",whiteSpace:"pre-wrap",wordBreak:"break-word"},placeholder:{fontSize:"12px",color:"#888",...C.overflow("hidden"),position:"absolute",textOverflow:"ellipsis",top:"10px",left:"10px",userSelect:"none",whiteSpace:"nowrap",display:"inline-block",pointerEvents:"none"}}),Y=new Set;function se(f){if(!Y.has(f))throw new Promise(b=>{const p=new Image;p.src=f,p.onload=()=>{Y.add(f),b(null)}})}function re({altText:f,className:b,imageRef:p,src:E,width:v,height:S,maxWidth:_}){return se(E),a.jsx("img",{className:b||void 0,src:E,alt:f,ref:p,style:{height:S,maxWidth:_,width:v},draggable:"false"})}function de({src:f,altText:b,nodeKey:p,width:E,height:v,maxWidth:S,resizable:_,showCaption:M,caption:z,captionsEnabled:O}){const y=m.useRef(null),P=m.useRef(null),[l,h,A]=B.useLexicalNodeSelection(p),[L,$]=m.useState(!1),[u]=X.useLexicalComposerContext(),[I,x]=m.useState(null),W=m.useRef(null),D=m.useCallback(e=>{if(l&&r.$isNodeSelection(r.$getSelection())){e.preventDefault();const R=r.$getNodeByKey(p);j(R)&&R.remove(),h(!1)}return!1},[l,p,h]),c=m.useCallback(e=>{const d=r.$getSelection(),R=P.current;if(l&&r.$isNodeSelection(d)&&d.getNodes().length===1){if(M)return r.$setSelection(null),e.preventDefault(),z.focus(),!0;if(R!==null&&R!==document.activeElement)return e.preventDefault(),R.focus(),!0}return!1},[z,l,M]),t=m.useCallback(e=>W.current===z||P.current===e.target?(r.$setSelection(null),u.update(()=>{h(!0);const d=u.getRootElement();d!==null&&d.focus()}),!0):!1,[z,u,h]);m.useEffect(()=>K.mergeRegister(u.registerUpdateListener(({editorState:e})=>{x(e.read(()=>r.$getSelection()))}),u.registerCommand(r.SELECTION_CHANGE_COMMAND,(e,d)=>(W.current=d,!1),r.COMMAND_PRIORITY_LOW),u.registerCommand(r.CLICK_COMMAND,e=>{const d=e;return L?!0:d.target===y.current?(d.shiftKey?h(!l):(A(),h(!0)),!0):!1},r.COMMAND_PRIORITY_LOW),u.registerCommand(r.DRAGSTART_COMMAND,e=>e.target===y.current?(e.preventDefault(),!0):!1,r.COMMAND_PRIORITY_LOW),u.registerCommand(r.KEY_DELETE_COMMAND,D,r.COMMAND_PRIORITY_LOW),u.registerCommand(r.KEY_BACKSPACE_COMMAND,D,r.COMMAND_PRIORITY_LOW),u.registerCommand(r.KEY_ENTER_COMMAND,c,r.COMMAND_PRIORITY_LOW),u.registerCommand(r.KEY_ESCAPE_COMMAND,t,r.COMMAND_PRIORITY_LOW)),[A,u,L,l,p,D,c,t,h]);function n(){u.update(()=>{const e=r.$getNodeByKey(p);j(e)&&e.setShowCaption(!0)})}function s(e,d){setTimeout(()=>{$(!1)},200),u.update(()=>{const R=r.$getNodeByKey(p);j(R)&&R.setWidthAndHeight(e,d)})}const w=l&&r.$isNodeSelection(I)&&!L,g=l||L,i=te();return a.jsxs(m.Suspense,{children:[a.jsx("div",{draggable:w,children:a.jsx(re,{className:g?`focused ${r.$isNodeSelection(I)?"draggable":""}`:null,src:f,altText:b,imageRef:y,width:E,height:v,maxWidth:S})}),M&&a.jsx("div",{className:N("LexEditor_ImageCaption",i.caption),children:a.jsxs(Q.LexicalNestedComposer,{initialEditor:z,children:[a.jsx(F.AutoFocusPlugin,{}),a.jsx(U,{}),a.jsx(G.RichTextPlugin,{contentEditable:a.jsx(V,{className:i.content}),placeholder:a.jsx(q,{className:i.placeholder,children:"Enter a caption..."}),ErrorBoundary:J})]})}),_&&r.$isNodeSelection(I)&&g&&a.jsx(Z,{showCaption:M,setShowCaption:n,editor:u,buttonRef:P,imageRef:y,maxWidth:S,onResizeStart:()=>$(!0),onResizeEnd:s,captionsEnabled:O})]})}export{de as default};
